#!/bin/bash
set -e

echo "Running pre-commit checks..."

# Get list of staged C/C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|h)$')

if [[ "$STAGED_FILES" = "" ]]; then
  echo "No C/C++ files staged for commit. Skipping linting."
  exit 0
fi

# Check for clang-format
if ! command -v clang-format &> /dev/null; then
  echo "Error: clang-format is not installed. Please install it to continue."
  exit 1
fi

# Check for cppcheck
if ! command -v cppcheck &> /dev/null; then
  echo "Error: cppcheck is not installed. Please install it to continue."
  exit 1
fi

# Format all staged C/C++ files
echo "Formatting code with clang-format..."
for FILE in $STAGED_FILES; do
  echo "  Formatting $FILE"
  clang-format -i "$FILE"
  git add "$FILE"
done

# Run cppcheck on all staged C/C++ files
echo "Running cppcheck..."
cppcheck --enable=all --inline-suppr --suppress=missingIncludeSystem $STAGED_FILES

echo "Pre-commit checks completed successfully!"
exit 0 